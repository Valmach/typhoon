<!DOCTYPE html>
<!--
%%
%%   Copyright 2015 Zalando SE
%%
%%   Licensed under the Apache License, Version 2.0 (the "License");
%%   you may not use this file except in compliance with the License.
%%   You may obtain a copy of the License at
%%
%%       http://www.apache.org/licenses/LICENSE-2.0
%%
%%   Unless required by applicable law or agreed to in writing, software
%%   distributed under the License is distributed on an "AS IS" BASIS,
%%   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
%%   See the License for the specific language governing permissions and
%%   limitations under the License.
%%
-->
<meta charset="utf-8">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<link href="https://talkslab.github.io/metro-bootstrap/dist/css/metro-bootstrap.min.css" rel="stylesheet">

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="/js/bullet.js"></script>

<script src="http://square.github.com/cubism/cubism.v1.js"></script>
<script src="https://cdn.rawgit.com/fogfish/monad.js/master/src/monad.js"></script>

<!--
%%
%% Styles
%%
-->
<style>
body 
{
   padding-top: 80px;
   padding-bottom: 20px;
   /*background: #272822;*/
}

.container
{
   width: 960px;
   padding: 0px;
   position: relative;
}

header 
{
  padding: 6px 0;
}

.group 
{
  margin-bottom: 1em;
}

.axis 
{
  font: 10px sans-serif;
  position: fixed;
  pointer-events: none;
  z-index: 2;
}

.axis text 
{
  -webkit-transition: fill-opacity 250ms linear;
}

.axis path 
{
  display: none;
}

.axis line 
{
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis.top 
{
  position: relative;
  background-image: linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -o-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -moz-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -webkit-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -ms-linear-gradient(top, #fff 0%, rgba(255,255,255,0) 100%);
  top: 0px;
  padding: 0 0 24px 0;
}

.axis.bottom 
{
  position: relative;
  background-image: linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -o-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -moz-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -webkit-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  background-image: -ms-linear-gradient(bottom, #fff 0%, rgba(255,255,255,0) 100%);
  bottom: 0px;
  padding: 24px 0 0 0;
}

.horizon 
{
  border-bottom: solid 1px #000;
  overflow: hidden;
  position: relative;
}

.horizon 
{
  border-top: solid 1px #000;
  border-bottom: solid 1px #000;
}

.horizon:hover
{
   background: #f8f8f8;
}

.horizon + .horizon 
{
  border-top: none;
}

.horizon canvas 
{
  display: block;
}

.horizon .title,
.horizon .value 
{
  bottom: 0;
  /*line-height: 30px;*/
  margin: 0 6px;
  position: absolute;
  text-shadow: 0 1px 4px rgba(255,255,255,.9);
  white-space: nowrap;
}

.horizon .title 
{
   top: 0;
   left: 0;
   font-size: 10px;
   margin: 0 0 0 0;
   width: 120px;
}


.horizon .value 
{
   right: 0;
   font-size: 12px;
   color: black;
   text-shadow: 0px 0px 10px rgba(255,255,255,1);
}

.line 
{
   background: #000;
   z-index: 2;
}

.progress
{
   margin: 0px;
   height: 2px;
   -webkit-box-shadow: none;
   box-shadow: none;
}


.chart {
    font-family: Arial, sans-serif;
    font-size: 10px;
  }

  .axis path, .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

.bar 
{
   fill: #299DE1;
   stroke-width: 1px;
   stroke: white
}

.bar:hover
{
   fill: #FF5722;
}

.d3-tip 
{
  line-height: 1;
  font-size: 10px;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after 
{
  display: inline;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after 
{
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}


.bullet { font: 10px sans-serif; }
.bullet .marker { stroke: #000; stroke-width: 2px; }
.bullet .tick line { stroke: #666; stroke-width: .5px; }
.bullet .range.s0 { fill: #eee; }
.bullet .range.s1 { fill: #ddd; }
.bullet .range.s2 { fill: #ccc; }
.bullet .measure.s0 { fill: lightsteelblue; }
.bullet .measure.s1 { fill: steelblue; }
.bullet .measure.s2 { fill: #3B7CA3; }
.bullet .measure.s3 { fill: #299DE1; }
.bullet .measure.s4 { fill: #FF7C53; }
.bullet .title { font-size: 14px; font-weight: bold; }
.bullet .subtitle { fill: #999; }

</style>


<body>


<nav class="navbar navbar-default navbar-fixed-top">
   <div class="container-fluid">
      <div class="navbar-header">
         <a class="navbar-brand" href="#">Typhoon</a>
      </div>
      <ul class="nav navbar-nav">
         <li><p id="scenario-id" class="navbar-text"></p></li>
      </ul>

      <ul class="nav navbar-nav navbar-right">
         <li><a href="https://github.com/zalando/typhoon"><span class="glyphicon glyphicon-star"></span> Star us on GitHub</a></li>
      </ul>
   </div>
   <!-- progress bar to visualize server delay -->
   <div class="progress">
      <div class="progress-bar" style="width: 0%;">
      </div>
   </div>
</nav>



<div class="jumbotron">
   <div class="container">
      <h1>Hello, world!</h1>
      <p>This is a template for a simple marketing or informational website. It includes a large callout called a jumbotron and three supporting pieces of content. Use it as a starting point to create something more unique.</p>
      <p><a class="btn btn-primary btn-lg" href="#" role="button">Learn more &raquo;</a></p>
   </div>
</div>



<div class="container">
   <div class="row">
      <div class="col-sm-6 col-md-2">
         <div class="thumbnail tile tile-medium tile-teal">
            <h2 class="tile-text">Capacity</h2>
            <h1 class="tile-text"><span id="tile-capacity"></span></h1>
         </div>
      </div>

      <div class="col-sm-6 col-md-2">
         <div class="thumbnail tile tile-medium tile-teal">
            <h2 class="tile-text">Availability</h2>
            <h1 class="tile-text"><span id="tile-availability"></span></h1>
         </div>
      </div>

      <div class="col-sm-6 col-md-2">
         <div class="thumbnail tile tile-medium tile-teal">
            <h2 class="tile-text">Latency</h2>
            <h1 class="tile-text"><span id="tile-latency"></span></h1>
         </div>
      </div>

      <div class="col-sm-6 col-md-2">
         <div class="thumbnail tile tile-medium tile-teal">
            <h2 class="tile-text">Session</h2>
            <h1 class="tile-text"><span id="tile-session"></span></h1>
         </div>
      </div>

      <div class="col-sm-6 col-md-2">
         <div class="thumbnail tile tile-medium tile-teal">
            <h2 class="tile-text">Nodes</h2>
            <h1 class="tile-text"><span id="tile-cluster"></span></h1>
         </div>
      </div>

      <div class="col-sm-6 col-md-2">
         <div class="thumbnail tile tile-medium tile-teal">
            <h2 class="tile-text">History</h2>
            <h1 class="tile-text"><span id="tile-history"></span></h1>
         </div>
      </div>
   </div>
</div>

<div class="container cubism">
   <div id="series" class="container">
   </div>
</div>



<div class="container">
   <h1>History</h1>
   <div id="history"></div> 

   <h2>Capacity (RPS)</h2>
   <div id="capacity"></div>

   <h2>Time To First Byte (ms)</h2>
   <div id="latency-ttfb"></div>

   <h2>Time To Response (ms)</h2>
   <div id="latency-ttmr"></div>

   <h2>Network Round Trip (ms)</h2>
   <div id="latency-tcp"></div>

   <h2>SSL Handshake (ms)</h2>
   <div id="latency-ssl"></div>

   <h2>Packet Per Second (ms)</h2>
   <div id="pps"></div>

   <h2>Packet Size (byte)</h2>
   <div id="packet"></div>
</div>










    <div class="container">
      <h1>Xxx</h1>
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-md-4">
          <h2>Heading</h2>
          <p>Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. Etiam porta sem malesuada magna mollis euismod. Donec sed odio dui. </p>
          <p><a class="btn btn-default" href="#" role="button">View details &raquo;</a></p>
        </div>
        <div class="col-md-4">
          <h2>Heading</h2>
          <p>Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. Etiam porta sem malesuada magna mollis euismod. Donec sed odio dui. </p>
          <p><a class="btn btn-default" href="#" role="button">View details &raquo;</a></p>
       </div>
        <div class="col-md-4">
          <h2>Heading</h2>
          <p>Donec sed odio dui. Cras justo odio, dapibus ac facilisis in, egestas eget quam. Vestibulum id ligula porta felis euismod semper. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus.</p>
          <p><a class="btn btn-default" href="#" role="button">View details &raquo;</a></p>
        </div>
      </div>


      <hr>

      <footer>
        <p>&copy; 2015 Company, Inc.</p>
      </footer>

</div>


<!--
%%
%% Controller
%%
-->
<script type="text/javascript">
var context = null;
var model = {
   scenario: {id: window.location.pathname.substring(1)},
   runtime: {},
   cluster: {peer: []},
   archive: {
      capacity: d3.map(),
      ttfb: d3.map(),
      ttmr: d3.map(),
      tcp: d3.map(),
      ssl: d3.map(),
      pps: d3.map(),
      pack: d3.map()
   }
};
//--------------------------------------------------------------------------
//
// action
//
//--------------------------------------------------------------------------
var actionIO = (function()
{
   var self = {};

   //
   self.scenario = function(id, accept)
   {
   }.curry();

   //
   self.attributes = function(id, accept)
   {
      d3.json('/scenario/' + id + '/attributes',
         function(json)
         {
            accept(json)
         }
      )
   }.curry();

   //
   self.cluster = function(accept)
   {
      d3.json('/health/peer',
         function(json)
         {
            accept(json)
         }
      )
   }.curry();

   //
   self.series = function(id, urn, title) 
   {
      return context.metric(function(start, stop, step, callback) {
         d3.json("/scenario/" + id + "/cubism/" + urn 
            + "/" + start.getTime() / 1000
            + "/" + stop.getTime() / 1000 
            + "?chronon=" + step / 1000, 
            function(data) {
               if (!data) return callback(new Error("unable to load data"));
               callback(null, data.map(function(x){return x[1]}))
            });
         }, title);
   };

   //
   self.history = function(id, accept)
   {
      d3.json('/scenario/' + id + '/history',
         function(json)
         {
            accept(json)
         }
      )
   }.curry();

   //
   self.archive = function(id, urn, from, to, accept)
   {
      d3.json('/scenario/' + id + '/series/' + urn + '/' + from + '/' + to,
         function(json)
         {
            accept(json)
         }
      )
   }.curry();

   return self;   
})();

var actionUI = (function()
{
   var self = {};

   //
   self.after = function(t, data, accept)
   {
      d3.timer(
         function()
         {
            accept(data); 
            return true;
         }, 
         t
      );
   }.curry();

   return self;   
})();

//--------------------------------------------------------------------------
//
// presenter
//
//--------------------------------------------------------------------------
var present = (function()
{
   var self = {};

   //
   self.attributes = function(model, json)
   {
      model.scenario.t = json.t
      model.scenario.n = json.n
      model.scenario.urn = json.urn
      model.runtime.session  = json.session
      model.runtime.capacity = json.capacity
      model.runtime.latency  = (json.latency / 1000).toFixed(1)
      model.runtime.availability = json.availability
      return model
   }.curry();

   //
   self.sensor = function(model)
   {
      model.scenario.sensor = model.scenario.urn.map(
         function(urn)
         {
            var sid = model.scenario.id
            return {
               id: urn,
               series: [
                  {id: sid, urn: "urn:c:2xx:" + urn.substring(4), title: 'http 2xx'}
                 ,{id: sid, urn: "urn:c:3xx:" + urn.substring(4), title: 'http 3xx'}
                 ,{id: sid, urn: "urn:c:4xx:" + urn.substring(4), title: 'http 4xx'}
                 ,{id: sid, urn: "urn:c:5xx:" + urn.substring(4), title: 'http 5xx'}
                 ,{id: sid, urn: "urn:g:tcp:" + urn.substring(4), title: 'tcp (μs)'}
                 ,{id: sid, urn: "urn:g:ssl:" + urn.substring(4), title: 'ssl (μs)'}
                 ,{id: sid, urn: "urn:g:ttfb:" + urn.substring(4), title: 'ttfb (μs)'}
                 ,{id: sid, urn: "urn:g:ttmr:" + urn.substring(4), title: 'ttmr (μs)'}
                 ,{id: sid, urn: "urn:c:pack:" + urn.substring(4), title: 'packet / sec'}
                 ,{id: sid, urn: "urn:g:pack:" + urn.substring(4), title: 'packet (byte)'}
               ]
            }
         }
      )
   }.curry();

   //
   self.cluster = function(model, json)
   {
      model.cluster.peer = json
      return model
   }.curry();

   //
   self.history = function(model, json)
   {
      model.scenario.history = json
      return model
   }.curry();

   //
   self.archive = function(model, type, urn, json)
   {
      var list = json.map(function(x){return x[1]}).sort(d3.ascending)
      var stat = {
         min: d3.min(list),
         mean: d3.mean(list),
         q50: d3.quantile(list, 0.50),
         q75: d3.quantile(list, 0.75),
         q80: d3.quantile(list, 0.80),
         q90: d3.quantile(list, 0.90),
         q95: d3.quantile(list, 0.95),
         q99: d3.quantile(list, 0.99),
         max: d3.max(list)
      }

      model.archive[type].set(urn, stat)
      return model
   }.curry();

   return self;   
})();

//--------------------------------------------------------------------------
//
// state
//
//--------------------------------------------------------------------------
var state = (function()
{
   var self   = {};
   var width  = 960;
   var height = 30;

   // create cubism context
   context = cubism.context()
      .step(1 * 1000)          // 1 second per value
      .size(width)
      .serverDelay(10 * 1000)  // time to collect and process metrics by server
      .clientDelay( 5 * 1000)
      .start();
   
   d3.select('.cubism').append("div")
      .attr("class", "rule")
      .call(context.rule());

   context.on("focus", 
      function(i) 
      {
         d3.selectAll(".value")
            .style("right", i == null ? null : context.size() - i + "px");
      }
   );

   //
   self.tiles = function(model)
   {
      d3.select("#tile-session").text(model.runtime.session)
      d3.select("#tile-capacity").text(model.runtime.capacity)
      d3.select("#tile-latency").text(model.runtime.latency)
      d3.select("#tile-availability").text(model.runtime.availability)
      d3.select("#tile-cluster").text(model.cluster.peer.length)
      d3.select("#tile-history").text(model.scenario.history.length)
      return model
   }.curry();
   
   //
   var vmHorizon = function(ui, list)
   {
      var data = list.map(
         function(x)
         {
            return actionIO.series(x.id, x.urn, x.title)
         }
      );

      d3.select(ui).selectAll(".horizon")
         .data(data, function(d){return d.toString()})
         .enter()
            .insert("div", ".bottom")
               .attr("class", "horizon")
               .call(
                  context.horizon()
                     .height( height )
                     .format(d3.format("+,.2d"))
               );
   }

   //
   self.series = function(model)
   {
      d3.select("#series").selectAll('div')
         .data(model.scenario.urn)
         .enter()
            .append('div')
            .attr('id', function(d){return d.split(':').join('_')})
            .classed('chronolog', true)
      
      model.scenario.sensor.map(
         function(x)
         {
            var ui = '#' + x.id.split(':').join('_')
            d3.select(ui).selectAll("*").remove();
            d3.select(ui).insert('h1').text(x.id)

            d3.select(ui).selectAll(".axis")
               .data(["top", "bottom"])
               .enter().append("div")
               .attr("class", function(d) {return d + " axis"; })
               .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            vmHorizon(ui, x.series)
         }
      )

      return model;
   }.curry();

   //
   self.history = function(model)
   {
      var margin = {top: 40, right: 40, bottom: 40, left:40}
      var height = 150;

      var data = model.scenario.history.map(
         function(d) 
         {
            return {date: new Date(d[0] * 1000), t: ~~(d[1] / 1000)}
         }
      ) 

      var ta = d3.time.hour.offset(data[0].date, -1)
      var tb = d3.time.hour.offset(data[data.length - 1].date, 1)
      var x  = d3.time.scale()
         .domain([ta, tb])
         .rangeRound([0, width - margin.left - margin.right]);

      var y = d3.scale.linear()
         .domain([0, d3.max(data, function(d) { return d.t; })])
         .range([height - margin.top - margin.bottom, 0]);

      var xAxis = d3.svg.axis()
         .scale(x)
         .orient('bottom')
         .ticks(12)
         .tickFormat(d3.time.format('%a %d %H:%M'))
         .tickSize(4)
         .tickPadding(4);

      var tip = d3.tip()
         .attr('class', 'd3-tip')
         .offset([-10, 0])
         .html(function(d) {return d.date;})

      var svg = d3.select('#history').append('svg')
         .attr('class', 'chart')
         .attr('width', width)
         .attr('height', height)
         .append('g')
            .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');
      svg.call(tip)

      svg.selectAll('.chart')
         .data(data)
         .enter().append('rect')
            .attr('class', 'bar')
            .attr('x', function(d) { return x(new Date(d.date)); })
            .attr('y', function(d) { return y(d.t) })
            .attr('width', 5.5)
            .attr('height', function(d) {return height - margin.top - margin.bottom - y(d.t) })
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide)
            .on('click', chain.history);

      svg.append('g')
         .attr('class', 'x axis')
         .attr('transform', 'translate(0, ' + (height - margin.top - margin.bottom) + ')')
         .call(xAxis);

      return model;
   }.curry();

   //
   self.bullet = function(ui, type, model)
   {
      console.log(model)
      var data = model.scenario.urn.map(
         function(urn)
         {
            var stat = model.archive[type].get(urn)
            return {
               title: urn,
               subtitle: 'rps',
               ranges: [stat.min, stat.mean, stat.max],
               measures: [stat.q75, stat.q80, stat.q90, stat.q95, stat.q99],
               markers: [stat.q50]
            }
         }
      )

      var margin = {top: 5, right: 40, bottom: 20, left: 120};
      var width  = 800;
      var height = 50 - margin.top - margin.bottom;

      var chart = d3.bullet()
         .width(width)
         .height(height);
      
      d3.select(ui).selectAll('*').remove();
      var svg = d3.select(ui).selectAll("svg")
         .data(data)
         .enter().append("svg")
            .attr("class", "bullet")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
               .call(chart);

      var title = svg.append("g")
         .style("text-anchor", "end")
         .attr("transform", "translate(-6," + height / 2 + ")");

      title.append("text")
         .attr("class", "title")
         .text(function(d) { return d.title; });

      title.append("text")
         .attr("class", "subtitle")
         .attr("dy", "1em")
         .text(function(d) { return d.subtitle; });

      return model;
   }.curry();

   return self;   
})();



//--------------------------------------------------------------------------
//
// chain
//
//--------------------------------------------------------------------------
var chain = (function()
{
   var self = {};

   //
   self.bootstrap = function()
   {
      monad.do([
         monad.IO(actionIO.cluster),
         present.cluster(model),
         function(_)
         {
            return monad.IO(actionIO.attributes(model.scenario.id))
         },
         present.attributes(model),
         present.sensor(),
         function(_)
         {
            return monad.IO(actionIO.history(model.scenario.id))
         },         
         present.history(model),
         state.tiles(),
         state.series(),
         state.history()
      ])
      self.poll_attributes()
      self.poll_cluster()
   }

   //
   self.poll_attributes = function()
   {
      monad.do([
         monad.UI(actionUI.after(5000, 'tick')),
         function(_) 
         {
            return monad.IO(actionIO.attributes(model.scenario.id))
         },
         present.attributes(model),
         state.tiles(),
         chain.poll_attributes
      ])
   }
   
   //
   self.poll_cluster = function()
   {
      monad.do([
         monad.UI(actionUI.after(60000, 'tick')),
         function(_) 
         {
            return monad.IO(actionIO.cluster)
         },
         present.cluster(model),
         state.tiles(),
         chain.poll_cluster
      ])
   }

   //
   self.history = function(x)
   {
      var ta = x.date.getTime() / 1000
      var tb = ta + x.t

      self.archive('#capacity', 'capacity', "urn:c:2xx:", ta, tb)
      self.archive('#latency-ttfb', 'ttfb', "urn:g:ttfb:", ta, tb)
      self.archive('#latency-ttmr', 'ttmr', "urn:g:ttmr:", ta, tb)
      self.archive('#latency-tcp', 'tcp', "urn:g:tcp:", ta, tb)
      self.archive('#latency-ssl', 'ssl', "urn:g:ssl:", ta, tb)

      self.archive('#pps', 'pps', "urn:c:pack:", ta, tb)
      self.archive('#packet', 'pack', "urn:g:pack:", ta, tb)
   }

   self.archive = function(ui, type, prefix, ta, tb)
   {

      var fn = model.scenario.urn.map(
         function(urn)
         {
            var id = prefix + urn.substring(4)
            return [
               monad.IO(actionIO.archive(model.scenario.id, id, ta, tb)),
               present.archive(model, type, urn)
            ]
         }
      )
      var head = fn.shift()
      var list = fn.reduce(
         function(acc, x)
         {
            return acc.concat([function(_){return x[0]}, x[1]])
         },
         head
      )
      monad.do(
         list.concat([state.bullet(ui, type)])
      )
   }

   return self;   
})();


chain.bootstrap();





















var pcolors = [
   "#ffa500",
   "#d88c00",
   "#b17200",
   "#9d6600",

   "#00caec",
   "#00a8c5",
   "#00879e",
   "#006576"
];
var scolors = [
   "#00caec",
   "#00a8c5",
   "#00879e",
   "#006576",

   "#ffa500",
   "#d88c00",
   "#b17200",
   "#9d6600"
];




//--------------------------------------------------------------------------
//
// scenario
//
//--------------------------------------------------------------------------
function unit(a, b, c) 
{
   return {title: a, urn: b, kpi: c}
}

var scenario = function(id, ts) 
{
   var self = {}
   
   //
   // check scenario status
   self.ping = function()
   {
      d3.json("/scenario/" + id + "/ping", self.view)
      return true;
   }

   //
   // visualize scenario status
   self.view = function(json)
   {
      d3.select("#scenario-processes").text(json.processes)
      d3.select("#scenario-rps").text(json.rps.toFixed(1))
      d3.timer(self.ping, 1000);
   }

   //
   // initialize scenario
   self.init = function()
   {
      d3.select("#scenario-run").on("click",
         function()
         {
            d3.select("nav").select(".progress-bar")
               .transition()
               .style("width", "100%")
               .duration(65000)
               .ease("linear")
               .each("end", 
                  function()
                  {
                     d3.select(this).style("width", "0%");
                     self.analysis();
                  }
               )

            d3.text("/scenario/" + id + "/spawn", function(data){ })
         }
      );
      d3.json("/scenario/" + id + "/attributes",
         function(json)
         {
            var urn = json
               .urn
               .map(function(x){return unit(x, x, "rps")});
            
            // d3.select("#url").text(json.url);
            d3.select("#url").text(id);
            ts.series(urn, "rps");
            self.latency("" + urn[0].urn);
            self.analysis();
         }
      ) 
   }


   return self;
}
</script>


</body>
